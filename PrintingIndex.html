<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the drawer transition */
        #advanced-drawer {
            transition: transform 0.3s ease-in-out;
        }
        /* Style for active option buttons */
        .option-btn.active {
            background-color: #2563eb; /* Corresponds to Tailwind's blue-600 */
            color: white;
        }
        /* Remove arrows from number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Style for remove buttons */
        .remove-row-btn {
            color: #ef4444;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .remove-row-btn:hover {
            color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl shadow-lg rounded-lg overflow-hidden bg-white">
        <div class="flex">
            <!-- Main Content -->
            <div class="flex-grow p-6">
                <h1 class="text-xl font-semibold text-gray-800 mb-6">Printing Cost Calculator</h1>

                <!-- Description and Quantity Section -->
                <div class="grid grid-cols-12 gap-x-2 mb-6 items-start">
                    <div class="col-span-8">
                        <label class="text-xs font-medium text-gray-600 block text-left">Description</label>
                        <textarea id="description" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs" rows="3"></textarea>
                    </div>
                    <div class="col-span-4">
                        <label class="text-xs font-medium text-gray-600 block text-left">Quantity</label>
                        <input id="quantity" type="number" min="1" value="1" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs h-7" />
                    </div>
                </div>

                <!-- Material Selection -->
                <div class="mb-6">
                    <label class="text-xs font-medium text-gray-600 block text-left">Material</label>
                    <select id="material" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs">
                        <option value="">Select Material</option>
                    </select>
                    <div id="error-message" class="text-xs text-red-600 mt-1 hidden"></div>
                </div>

                <!-- Dimensions Section -->
                <div class="grid grid-cols-2 gap-x-4 mb-6">
                    <div>
                        <label class="text-xs font-medium text-gray-600 block text-left">Width (inches)</label>
                        <input id="width" type="number" step="0.1" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs h-7" placeholder="0.0" />
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600 block text-left">Height (inches)</label>
                        <input id="height" type="number" step="0.1" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs h-7" placeholder="0.0" />
                    </div>
                </div>

                <!-- Options Section -->
                <div class="mb-6">
                    <label class="text-xs font-medium text-gray-600 block text-left mb-2">Options</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="complexShape" class="mr-2">
                            <span class="text-xs">Complex Shape</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="doubleSided" class="mr-2">
                            <span class="text-xs">Double Sided</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="lamination" class="mr-2">
                            <span class="text-xs">Lamination</span>
                        </label>
                    </div>
                </div>

                <!-- Bottom/Results Section -->
                <div class="flex flex-col justify-between rounded-md bg-gray-100 p-3 mt-auto">
                   <div class="grid sm:grid-cols-[1fr_auto_1fr] items-center gap-x-4 gap-y-4 h-full">
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 items-center"><div class="text-xs text-left">Total Cost</div><div id="total-cost" class="text-xs text-left font-semibold">$0.00</div></div>
                            <div class="grid grid-cols-2 items-center">
                                <div class="text-xs text-left">Margin</div>
                                 <div class="relative w-20">
                                    <input id="margin" type="number" value="60" min="0" step="1" class="w-full h-8 pr-6 pl-2 border border-gray-300 rounded-md text-sm" />
                                    <span class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-500 text-sm">%</span>
                                 </div>
                            </div>
                             <div class="grid grid-cols-2 items-center"><div class="text-xs text-left">Total Price</div><div id="total-price" class="text-xs text-left font-semibold">$0.00</div></div>
                             <div class="grid grid-cols-2 items-center"><div class="text-xs text-left">Unit Price</div><div id="unit-price" class="text-xs text-left font-semibold">$0.00</div></div>
                        </div>
                        <div class="hidden sm:flex justify-center h-full"><div class="border-l border-gray-300"></div></div>
                        <div class="flex flex-col justify-center items-center gap-2.5">
                            <button id="add-to-project-btn" class="w-full bg-blue-600 text-white px-4 py-1 rounded-md text-sm hover:bg-blue-700">Add to Project</button>
                            <button id="reset-btn" class="w-full bg-white border border-gray-300 px-4 py-1 rounded-md text-sm hover:bg-gray-50">Reset</button>
                        </div>
                   </div>
                </div>

            </div>
            
            <!-- Drawer Trigger -->
            <div id="drawer-trigger" class="flex-shrink-0 bg-gray-50 hover:bg-gray-200 transition-colors cursor-pointer flex items-center justify-center w-10" style="box-shadow: -4px 0 12px -4px rgba(0,0,0,0.05)">
                <div class="flex flex-col items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    <span class="text-xs font-medium text-gray-500" style="writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);">Advanced Settings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Drawer -->
    <div id="advanced-drawer" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl p-4 transform translate-x-full z-50 transition-transform duration-300">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-base font-semibold">Advanced Settings</h2>
            <button id="close-drawer-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        
        <!-- Advanced Options Content -->
        <div class="space-y-0">
            <!-- Labor Design -->
            <div class="py-3">
                <div class="space-y-2">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="design-labor-checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="design-labor-checkbox" class="text-sm text-gray-700 font-medium">Labor Design</label>
                    </div>
                    <div class="ml-7 text-xs text-gray-500">$60.00 per hour</div>
                    <div id="design-labor-inputs" class="ml-7 hidden mt-2">
                        <div class="flex gap-x-2">
                            <input type="number" id="design-labor-quantity" class="w-20 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="0" min="0" step="0.1" />
                            <select id="design-labor-unit" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="hours">Hours</option>
                                <option value="minutes">Minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="border-gray-200">
            
            <!-- Labor Decals -->
            <div class="py-3">
                <div class="space-y-2">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="decals-labor-checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="decals-labor-checkbox" class="text-sm text-gray-700 font-medium">Labor Decals</label>
                    </div>
                    <div class="ml-7 text-xs text-gray-500">$28.00 per hour</div>
                    <div id="decals-labor-inputs" class="ml-7 hidden mt-2">
                        <div class="flex gap-x-2">
                            <input type="number" id="decals-labor-quantity" class="w-20 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="0" min="0" step="0.1" />
                            <select id="decals-labor-unit" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="hours">Hours</option>
                                <option value="minutes">Minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="border-gray-200">
            
            <!-- Labor Finishing -->
            <div class="py-3">
                <div class="space-y-2">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="finishing-labor-checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="finishing-labor-checkbox" class="text-sm text-gray-700 font-medium">Labor Finishing</label>
                    </div>
                    <div class="ml-7 text-xs text-gray-500">$28.00 per hour</div>
                    <div id="finishing-labor-inputs" class="ml-7 hidden mt-2">
                        <div class="flex gap-x-2">
                            <input type="number" id="finishing-labor-quantity" class="w-20 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="0" min="0" step="0.1" />
                            <select id="finishing-labor-unit" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="hours">Hours</option>
                                <option value="minutes">Minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="border-gray-200">
            
            <!-- Labor Installing -->
            <div class="py-3">
                <div class="space-y-2">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="installing-labor-checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="installing-labor-checkbox" class="text-sm text-gray-700 font-medium">Labor Installing</label>
                    </div>
                    <div class="ml-7 text-xs text-gray-500">$28.00 per hour</div>
                    <div id="installing-labor-inputs" class="ml-7 hidden mt-2">
                        <div class="flex gap-x-2">
                            <input type="number" id="installing-labor-quantity" class="w-20 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="0" min="0" step="0.1" />
                            <select id="installing-labor-unit" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="hours">Hours</option>
                                <option value="minutes">Minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === GLOBAL VARIABLES ===
            let isEditMode = false;
            let originalRowNumber = null;
            
            // === State Management ===
            const state = {
                materials: [], materialName: '', description: '', quantity: 1, width: '', height: '',
                complexShape: false, doubleSided: false, lamination: false,
                designTime: '', laborDecalsTime: '', laborFinishingTime: '', laborInstallingTime: '',
                designTimeUnit: 'Minutes', laborDecalsTimeUnit: 'Minutes', laborFinishingTimeUnit: 'Minutes', laborInstallingTimeUnit: 'Minutes',
                margin: 60, isDrawerOpen: false,
            };

            // === DOM ELEMENTS ===
            const drawer = document.getElementById('advanced-drawer');
            const drawerTrigger = document.getElementById('drawer-trigger');
            const closeDrawerBtn = document.getElementById('close-drawer-btn');
            const resetBtn = document.getElementById('reset-btn');
            const addToProjectBtn = document.getElementById('add-to-project-btn');

            // === EDIT MODE INITIALIZATION ===
            if (window.editFormData) {
                isEditMode = true;
                originalRowNumber = window.editFormData.originalRowNumber;
                
                addToProjectBtn.textContent = 'Update Project';
                document.querySelector('h1').textContent = 'Edit Printing Cost Calculator';
                
                setTimeout(() => populateFormData(window.editFormData), 100);
            }

            // === Helper Functions ===
            const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(isNaN(value) ? 0 : value);
            const getTimeInHours = (time, unit) => {
                const numTime = Number(time) || 0;
                return unit === 'Minutes' ? numTime / 60 : numTime;
            };

            // === Calculation Logic ===
            function calculateEstimate() {
                const errorMessageDiv = document.getElementById('error-message');
                errorMessageDiv.textContent = '';
                errorMessageDiv.classList.add('hidden');

                const selectedMaterial = state.materials.find(m => m.name === state.materialName);

                if (!selectedMaterial || !state.quantity || !state.width || !state.height) {
                    resetCostsUI();
                    return;
                }
                
                const qty = Number(state.quantity) || 0;
                const artWidth = Number(state.width) || 0;
                const artHeight = Number(state.height) || 0;
                const bleed = 0.25;
                const spacing = 0.25;
                const artWidthTotal = artWidth + bleed;
                const artHeightTotal = artHeight + bleed;

                let materialCost = 0;
                let totalLinearFeet = 0;

                if (selectedMaterial.type === 'ROLL') {
                    const rollWidth = selectedMaterial.width;
                    if (artWidthTotal > rollWidth && artHeightTotal > rollWidth) {
                        errorMessageDiv.textContent = 'Artwork is wider than the selected roll.';
                        errorMessageDiv.classList.remove('hidden');
                        resetCostsUI();
                        return;
                    }
                    const linFtCost = selectedMaterial.costLinFt;
                    const colsPortrait = Math.floor((rollWidth + spacing) / (artWidthTotal + spacing));
                    const colsLandscape = Math.floor((rollWidth + spacing) / (artHeightTotal + spacing));
                    let numColumns = Math.max(colsPortrait, colsLandscape, 1);
                    let layoutRow = artHeightTotal;
                    if (colsLandscape > colsPortrait) layoutRow = artWidthTotal;
                    const numRows = Math.ceil(qty / numColumns);
                    const totalLinearInches = (numRows * layoutRow) + ((numRows - 1) * spacing);
                    totalLinearFeet = totalLinearInches / 12;
                    materialCost = (totalLinearFeet + 2.5) * linFtCost;
                } else if (selectedMaterial.type === 'SHEET') {
                    const sheetWidth = selectedMaterial.width;
                    const sheetHeight = selectedMaterial.height;
                    const artFitsPortrait = (artWidthTotal <= sheetWidth && artHeightTotal <= sheetHeight);
                    const artFitsLandscape = (artWidthTotal <= sheetHeight && artHeightTotal <= sheetWidth);
                    if (!artFitsPortrait && !artFitsLandscape) {
                        errorMessageDiv.textContent = 'Artwork is larger than the selected sheet.';
                        errorMessageDiv.classList.remove('hidden');
                        resetCostsUI();
                        return;
                    }
                    const sheetCost = selectedMaterial.costSheet;
                    const perSheet1 = artFitsPortrait ? Math.floor((sheetWidth + spacing) / (artWidthTotal + spacing)) * Math.floor((sheetHeight + spacing) / (artHeightTotal + spacing)) : 0;
                    const perSheet2 = artFitsLandscape ? Math.floor((sheetWidth + spacing) / (artHeightTotal + spacing)) * Math.floor((sheetHeight + spacing) / (artWidthTotal + spacing)) : 0;
                    const piecesPerSheet = Math.max(perSheet1, perSheet2, 1);
                    const totalSheets = Math.ceil(qty / piecesPerSheet);
                    let calculatedMaterialCost = totalSheets * sheetCost;
                    const halfSheetCost = sheetCost * 0.5;
                    materialCost = Math.max(calculatedMaterialCost, halfSheetCost);
                }

                const singlePieceSqFt = (artWidthTotal * artHeightTotal) / 144;
                let totalArtworkSqFt = singlePieceSqFt * qty;
                if (state.doubleSided) totalArtworkSqFt *= 2;
                const totalArtworkPerimeter = (artWidth * 2 + artHeight * 2) * qty;
                const printTimeHours = (totalArtworkSqFt / 0.83) / 60;
                let cutTimeHours = (totalArtworkPerimeter / 120) / 60;
                if (state.complexShape) cutTimeHours *= 1.5;
                const ripTimeHours = (totalArtworkSqFt / 20.52) / 60;
                const printComputeTimeHours = (totalArtworkSqFt / 6.2) / 60;
                const designTimeInHours = getTimeInHours(state.designTime, state.designTimeUnit);
                const laborDecalsTimeInHours = getTimeInHours(state.laborDecalsTime, state.laborDecalsTimeUnit);
                const laborFinishingTimeInHours = getTimeInHours(state.laborFinishingTime, state.laborFinishingTimeUnit);
                const laborInstallingTimeInHours = getTimeInHours(state.laborInstallingTime, state.laborInstallingTimeUnit);
                const manualOperatorTimeInHours = laborDecalsTimeInHours + laborFinishingTimeInHours + laborInstallingTimeInHours;
                const totalProjectRunTimeHours = printTimeHours + cutTimeHours + ripTimeHours + printComputeTimeHours;
                const inkCost = totalArtworkSqFt * 0.165;
                const cuttingCost = cutTimeHours * 25.00;
                const baseDesignCost = (totalArtworkSqFt / 25) * 0.0625 * 60.00;
                const manualDesignCost = designTimeInHours * 60.00;
                const designCost = baseDesignCost + manualDesignCost;
                let laminationCost = 0;
                if (state.lamination) {
                    if (selectedMaterial.type === 'ROLL') laminationCost = totalLinearFeet * 1.02;
                    else laminationCost = totalArtworkSqFt * 0.2267;
                }
                const equipmentCost = totalProjectRunTimeHours * 4.95;
                const operatorCost = (totalProjectRunTimeHours + manualOperatorTimeInHours) * 28.00;
                const calculatedTotalCosts = materialCost + inkCost + cuttingCost + designCost + equipmentCost + operatorCost + laminationCost;
                const numMargin = Number(state.margin) || 0;
                let calculatedTotalPrice = calculatedTotalCosts;
                if (numMargin < 100 && numMargin >= 0) calculatedTotalPrice = calculatedTotalCosts / (1 - (numMargin / 100));
                const calculatedUnitPrice = qty > 0 ? calculatedTotalPrice / qty : 0;

                updateCostsUI(calculatedTotalCosts, calculatedTotalPrice, calculatedUnitPrice);
            }

            // === UI Update Functions ===
            function updateCostsUI(total, price, unit) {
                document.getElementById('total-cost').textContent = formatCurrency(total);
                document.getElementById('total-price').textContent = formatCurrency(price);
                document.getElementById('unit-price').textContent = formatCurrency(unit);
            }

            function resetCostsUI() {
                updateCostsUI(0, 0, 0);
            }

            function resetForm() {
                Object.assign(state, {
                    description: '', materialName: '', quantity: 1, width: '', height: '',
                    complexShape: false, doubleSided: false, lamination: false,
                    designTime: '', laborDecalsTime: '', laborFinishingTime: '', laborInstallingTime: '',
                    designTimeUnit: 'Minutes', laborDecalsTimeUnit: 'Minutes', laborFinishingTimeUnit: 'Minutes', laborInstallingTimeUnit: 'Minutes',
                    margin: 60, isDrawerOpen: false,
                });
                document.getElementById('description').value = '';
                document.getElementById('material').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('width').value = '';
                document.getElementById('height').value = '';
                document.getElementById('margin').value = '60';
                document.getElementById('complexShape').checked = false;
                document.getElementById('doubleSided').checked = false;
                document.getElementById('lamination').checked = false;
                
                // Reset advanced options
                document.getElementById('design-labor-checkbox').checked = false;
                document.getElementById('decals-labor-checkbox').checked = false;
                document.getElementById('finishing-labor-checkbox').checked = false;
                document.getElementById('installing-labor-checkbox').checked = false;
                
                document.getElementById('design-labor-inputs').classList.add('hidden');
                document.getElementById('decals-labor-inputs').classList.add('hidden');
                document.getElementById('finishing-labor-inputs').classList.add('hidden');
                document.getElementById('installing-labor-inputs').classList.add('hidden');
                
                document.getElementById('design-labor-quantity').value = '';
                document.getElementById('decals-labor-quantity').value = '';
                document.getElementById('finishing-labor-quantity').value = '';
                document.getElementById('installing-labor-quantity').value = '';
                
                document.getElementById('design-labor-unit').value = 'hours';
                document.getElementById('decals-labor-unit').value = 'hours';
                document.getElementById('finishing-labor-unit').value = 'hours';
                document.getElementById('installing-labor-unit').value = 'hours';
                
                calculateEstimate();
            }

            function sendDataToProject() {
                const description = state.description || 'Description Details';
                const width = Number(state.width) || 0;
                const height = Number(state.height) || 0;
                const formattedDescription = `${description} - (${width}" x ${height}")`;

                const qty = Number(state.quantity) || 0;
                const priceText = document.getElementById('total-price').textContent;
                const totalPrice = parseFloat(priceText.replace(/[^0-9.-]+/g,""));
                const unitPrice = qty > 0 ? totalPrice / qty : 0;
                if (isNaN(qty) || isNaN(unitPrice) || isNaN(totalPrice) || qty === 0) {
                    alert("Please enter a valid quantity before adding to the project.");
                    return;
                }
                
                // Collect complete form data
                const completeFormData = collectFormData();
                
                const printingData = {
                    description: formattedDescription,
                    quantity: qty,
                    totalPrice: totalPrice,
                    formData: completeFormData,
                    originalRowNumber: isEditMode ? originalRowNumber : null
                };
                
                addToProjectBtn.disabled = true;
                const originalButtonText = addToProjectBtn.textContent;
                addToProjectBtn.textContent = isEditMode ? 'Updating...' : 'Adding...';
                addToProjectBtn.classList.add('opacity-50');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        addToProjectBtn.disabled = false;
                        addToProjectBtn.textContent = originalButtonText;
                        addToProjectBtn.classList.remove('opacity-50');
                        
                        if (result.success) {
                            if (result.isUpdate) {
                                resetFormToNewMode();
                            } else {
                                resetForm();
                            }
                        } else {
                            alert(`Error: ${result.message}`);
                        }
                    })
                    .withFailureHandler(function(error) {
                        addToProjectBtn.disabled = false;
                        addToProjectBtn.textContent = originalButtonText;
                        addToProjectBtn.classList.remove('opacity-50');
                        
                        console.error('Error adding to project:', error);
                        alert('An error occurred while adding to the project. Please try again.');
                    })
                    .addPrintingToProject(printingData);
            }

            function collectFormData() {
                const formData = {
                    description: state.description,
                    materialName: state.materialName,
                    quantity: state.quantity,
                    width: state.width,
                    height: state.height,
                    complexShape: state.complexShape,
                    doubleSided: state.doubleSided,
                    lamination: state.lamination,
                    designTime: state.designTime,
                    laborDecalsTime: state.laborDecalsTime,
                    laborFinishingTime: state.laborFinishingTime,
                    laborInstallingTime: state.laborInstallingTime,
                    designTimeUnit: state.designTimeUnit,
                    laborDecalsTimeUnit: state.laborDecalsTimeUnit,
                    laborFinishingTimeUnit: state.laborFinishingTimeUnit,
                    laborInstallingTimeUnit: state.laborInstallingTimeUnit,
                    margin: state.margin
                };

                if (isEditMode && originalRowNumber) {
                    formData.originalRowNumber = originalRowNumber;
                }

                return formData;
            }

            function populateFormData(formData) {
                if (!formData) return;

                if (formData.originalRowNumber) {
                    isEditMode = true;
                    originalRowNumber = formData.originalRowNumber;
                    
                    addToProjectBtn.textContent = 'Update Project';
                    document.querySelector('h1').textContent = 'Edit Printing Cost Calculator';
                }

                if (formData.description) document.getElementById('description').value = formData.description;
                if (formData.materialName) {
                    state.materialName = formData.materialName;
                    document.getElementById('material').value = formData.materialName;
                }
                if (formData.quantity) {
                    state.quantity = formData.quantity;
                    document.getElementById('quantity').value = formData.quantity;
                }
                if (formData.width) {
                    state.width = formData.width;
                    document.getElementById('width').value = formData.width;
                }
                if (formData.height) {
                    state.height = formData.height;
                    document.getElementById('height').value = formData.height;
                }
                if (formData.margin !== undefined) {
                    state.margin = formData.margin;
                    document.getElementById('margin').value = formData.margin;
                }

                if (formData.complexShape) {
                    state.complexShape = true;
                    document.getElementById('complexShape').checked = true;
                }
                if (formData.doubleSided) {
                    state.doubleSided = true;
                    document.getElementById('doubleSided').checked = true;
                }
                if (formData.lamination) {
                    state.lamination = true;
                    document.getElementById('lamination').checked = true;
                }

                // Advanced labor options
                if (formData.designTime) {
                    state.designTime = formData.designTime;
                    document.getElementById('design-labor-checkbox').checked = true;
                    document.getElementById('design-labor-inputs').classList.remove('hidden');
                    document.getElementById('design-labor-quantity').value = formData.designTime;
                    document.getElementById('design-labor-unit').value = formData.designTimeUnit === 'Minutes' ? 'minutes' : 'hours';
                }
                if (formData.laborDecalsTime) {
                    state.laborDecalsTime = formData.laborDecalsTime;
                    document.getElementById('decals-labor-checkbox').checked = true;
                    document.getElementById('decals-labor-inputs').classList.remove('hidden');
                    document.getElementById('decals-labor-quantity').value = formData.laborDecalsTime;
                    document.getElementById('decals-labor-unit').value = formData.laborDecalsTimeUnit === 'Minutes' ? 'minutes' : 'hours';
                }
                if (formData.laborFinishingTime) {
                    state.laborFinishingTime = formData.laborFinishingTime;
                    document.getElementById('finishing-labor-checkbox').checked = true;
                    document.getElementById('finishing-labor-inputs').classList.remove('hidden');
                    document.getElementById('finishing-labor-quantity').value = formData.laborFinishingTime;
                    document.getElementById('finishing-labor-unit').value = formData.laborFinishingTimeUnit === 'Minutes' ? 'minutes' : 'hours';
                }
                if (formData.laborInstallingTime) {
                    state.laborInstallingTime = formData.laborInstallingTime;
                    document.getElementById('installing-labor-checkbox').checked = true;
                    document.getElementById('installing-labor-inputs').classList.remove('hidden');
                    document.getElementById('installing-labor-quantity').value = formData.laborInstallingTime;
                    document.getElementById('installing-labor-unit').value = formData.laborInstallingTimeUnit === 'Minutes' ? 'minutes' : 'hours';
                }

                setTimeout(calculateEstimate, 100);
            }

            function resetFormToNewMode() {
                resetForm();
                isEditMode = false;
                originalRowNumber = null;
                addToProjectBtn.textContent = 'Add to Project';
                document.querySelector('h1').textContent = 'Printing Cost Calculator';
            }
            
            // === DOM Initialization ===
            google.script.run.withSuccessHandler(materials => {
                console.log('Materials received:', materials);
                state.materials = materials.map(m => ({
                    name: m[0], type: m[1], width: parseFloat(m[2]), height: parseFloat(m[3]), costSheet: parseFloat(m[4]), costLinFt: parseFloat(m[5])
                }));
                const materialSelect = document.getElementById('material');
                
                // Clear existing options
                materialSelect.innerHTML = '<option value="">Select Material</option>';
                
                state.materials.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.name;
                    option.textContent = m.name;
                    materialSelect.appendChild(option);
                });
                
                // If in edit mode, populate after materials are loaded
                if (window.editFormData) {
                    setTimeout(() => populateFormData(window.editFormData), 200);
                }
            }).withFailureHandler(error => {
                console.error('Error loading materials:', error);
                const materialSelect = document.getElementById('material');
                materialSelect.innerHTML = '<option value="">Error loading materials</option>';
            }).getPrintingMaterials();

            // Setup all event listeners
            document.getElementById('description').addEventListener('input', (e) => { state.description = e.target.value; });
            document.getElementById('material').addEventListener('change', (e) => { state.materialName = e.target.value; calculateEstimate(); });
            ['quantity', 'width', 'height', 'margin'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => { state[id] = e.target.value; calculateEstimate(); });
            });
            
            // Option checkboxes
            document.getElementById('complexShape').addEventListener('change', (e) => { state.complexShape = e.target.checked; calculateEstimate(); });
            document.getElementById('doubleSided').addEventListener('change', (e) => { state.doubleSided = e.target.checked; calculateEstimate(); });
            document.getElementById('lamination').addEventListener('change', (e) => { state.lamination = e.target.checked; calculateEstimate(); });
            
            document.getElementById('reset-btn').addEventListener('click', resetForm);
            document.getElementById('add-to-project-btn').addEventListener('click', sendDataToProject);
            
            // Drawer functionality
            if (drawerTrigger && drawer) {
                drawerTrigger.addEventListener('click', function() {
                    drawer.classList.remove('translate-x-full');
                });
            }
            if (closeDrawerBtn && drawer) {
                closeDrawerBtn.addEventListener('click', function() {
                    drawer.classList.add('translate-x-full');
                });
            }

            // Advanced labor checkboxes and inputs
            const advancedLabor = [
                { checkbox: 'design-labor-checkbox', inputs: 'design-labor-inputs', quantity: 'design-labor-quantity', unit: 'design-labor-unit', stateTime: 'designTime', stateUnit: 'designTimeUnit' },
                { checkbox: 'decals-labor-checkbox', inputs: 'decals-labor-inputs', quantity: 'decals-labor-quantity', unit: 'decals-labor-unit', stateTime: 'laborDecalsTime', stateUnit: 'laborDecalsTimeUnit' },
                { checkbox: 'finishing-labor-checkbox', inputs: 'finishing-labor-inputs', quantity: 'finishing-labor-quantity', unit: 'finishing-labor-unit', stateTime: 'laborFinishingTime', stateUnit: 'laborFinishingTimeUnit' },
                { checkbox: 'installing-labor-checkbox', inputs: 'installing-labor-inputs', quantity: 'installing-labor-quantity', unit: 'installing-labor-unit', stateTime: 'laborInstallingTime', stateUnit: 'laborInstallingTimeUnit' }
            ];

            advancedLabor.forEach(labor => {
                const checkbox = document.getElementById(labor.checkbox);
                const inputs = document.getElementById(labor.inputs);
                const quantityInput = document.getElementById(labor.quantity);
                const unitSelect = document.getElementById(labor.unit);

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        inputs.classList.remove('hidden');
                    } else {
                        inputs.classList.add('hidden');
                        state[labor.stateTime] = '';
                        quantityInput.value = '';
                    }
                    calculateEstimate();
                });

                quantityInput.addEventListener('input', (e) => {
                    state[labor.stateTime] = e.target.value;
                    calculateEstimate();
                });

                unitSelect.addEventListener('change', (e) => {
                    state[labor.stateUnit] = e.target.value === 'minutes' ? 'Minutes' : 'Hours';
                    calculateEstimate();
                });
            });

            updateCostsUI(0, 0, 0);
        });
    </script>
</body>
</html>
