<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the drawer transition */
        #advanced-drawer {
            transition: transform 0.3s ease-in-out;
        }
        /* Style for active option buttons */
        .option-btn.active {
            background-color: #2563eb; /* Corresponds to Tailwind's blue-600 */
            color: white;
        }
        /* Remove arrows from number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Style for remove buttons */
        .remove-row-btn {
            color: #ef4444;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .remove-row-btn:hover {
            color: #dc2626;
        }
        
        .hidden { display: none; }
        
        #error-message {
            color: #dc2626;
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 8px;
            min-height: 16px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl shadow-lg rounded-lg overflow-hidden bg-white">
        <div class="flex">
            <!-- Main Content -->
            <div class="flex-grow p-6">
                <h1 class="text-lg font-semibold text-gray-800 mb-4">PrintCut Estimate</h1>

                <!-- Description Section -->
                <div class="mb-4">
                    <label class="text-xs font-medium text-gray-700 block text-left mb-1">Description</label>
                    <input id="description" type="text" class="block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs" placeholder="Enter description..." />
                </div>

                <!-- Material Selection -->
                <div class="mb-4">
                    <label class="text-xs font-medium text-gray-700 block text-left mb-1">Material</label>
                    <select id="material" class="block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs">
                        <option disabled selected>Loading materials...</option>
                    </select>
                    <div id="error-message" class="text-xs"></div>
                    <div id="loading-message" class="text-xs text-gray-500 mt-1">Loading materials...</div>
                </div>

                <!-- Quantity and Dimensions Section -->
                <div class="grid grid-cols-12 gap-x-4 mb-4 items-start">
                    <div class="col-span-4">
                        <label class="text-xs font-medium text-gray-700 block text-left mb-1">Quantity</label>
                        <input id="qty" type="number" class="block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs" placeholder="1" min="1" step="1" />
                    </div>
                    <div class="col-span-4">
                        <label class="text-xs font-medium text-gray-700 block text-left mb-1">Artwork Width (in)</label>
                        <input id="width" type="number" class="block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs" placeholder="0" step="0.01" />
                    </div>
                    <div class="col-span-4">
                        <label class="text-xs font-medium text-gray-700 block text-left mb-1">Artwork Height (in)</label>
                        <input id="height" type="number" class="block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs" placeholder="0" step="0.01" />
                    </div>
                </div>

                <!-- Options Section -->
                <div class="mb-4">
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="complex-shape" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="complex-shape" class="ml-2 block text-xs text-gray-700">Complex Shape</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="double-sided" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="double-sided" class="ml-2 block text-xs text-gray-700">Double Sided</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="lamination" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="lamination" class="ml-2 block text-xs text-gray-700">Lamination</label>
                        </div>
                    </div>
                </div>

                <!-- Bottom/Results Section -->
                <div class="flex flex-col justify-between rounded-md bg-gray-100 p-3 mt-auto">
                   <div class="grid sm:grid-cols-[1fr_auto_1fr] items-center gap-x-4 gap-y-4 h-full">
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 items-center"><div class="text-xs text-left">Total Cost</div><div id="total-cost" class="text-xs text-left font-semibold">$0.00</div></div>
                            <div class="grid grid-cols-2 items-center">
                                <div class="text-xs text-left">Margin</div>
                                 <div class="relative w-20">
                                    <input id="margin" type="number" value="50" min="0" step="1" class="w-full h-8 pr-6 pl-2 border border-gray-300 rounded-md text-sm" />
                                    <span class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-500 text-sm">%</span>
                                 </div>
                            </div>
                             <div class="grid grid-cols-2 items-center"><div class="text-xs text-left">Total Price</div><div id="total-price" class="text-xs text-left font-semibold">$0.00</div></div>
                             <div class="grid grid-cols-2 items-center"><div class="text-xs text-left">Unit Price</div><div id="unit-price" class="text-xs text-left font-semibold">$0.00</div></div>
                        </div>
                        <div class="hidden sm:flex justify-center h-full"><div class="border-l border-gray-300"></div></div>
                        <div class="flex flex-col justify-center items-center gap-2.5">
                            <button id="add-to-project-btn" class="w-full bg-blue-600 text-white px-4 py-1 rounded-md text-sm hover:bg-blue-700">Add to Project</button>
                            <button id="reset-btn" class="w-full bg-white border border-gray-300 px-4 py-1 rounded-md text-sm hover:bg-gray-50">Reset</button>
                        </div>
                   </div>
                </div>

            </div>
            
            <!-- Drawer Trigger -->
            <div id="drawer-trigger" class="flex-shrink-0 bg-gray-50 hover:bg-gray-200 transition-colors cursor-pointer flex items-center justify-center w-10" style="box-shadow: -4px 0 12px -4px rgba(0,0,0,0.05)">
                <div class="flex flex-col items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    <span class="text-xs font-medium text-gray-500" style="writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);">Advanced Settings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Options Drawer -->
    <div id="advanced-drawer" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl p-4 transform translate-x-full z-50">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-base font-semibold">Advanced Settings</h2>
            <button id="close-drawer-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        
        <!-- Advanced Options Content -->
        <div class="space-y-0">
            <!-- Additional Labor Section -->
            <div class="py-3">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Additional Labor</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Design</span>
                        <div class="flex gap-2">
                            <input type="number" id="design-time" placeholder="0" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                            <select id="design-unit" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="minutes">Minutes</option>
                                <option value="hours">Hours</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Weeding</span>
                        <div class="flex gap-2">
                            <input type="number" id="weeding-time" placeholder="0" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                            <select id="weeding-unit" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="minutes">Minutes</option>
                                <option value="hours">Hours</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Masking</span>
                        <div class="flex gap-2">
                            <input type="number" id="masking-time" placeholder="0" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                            <select id="masking-unit" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="minutes">Minutes</option>
                                <option value="hours">Hours</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Finishing</span>
                        <div class="flex gap-2">
                            <input type="number" id="finishing-time" placeholder="0" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                            <select id="finishing-unit" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="minutes">Minutes</option>
                                <option value="hours">Hours</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-2">$60.00 per hour</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === GLOBAL VARIABLES ===
            let isEditMode = false;
            let originalRowNumber = null;
            let materialInventoryData = [];

            // === DOM ELEMENTS ===
            const drawer = document.getElementById('advanced-drawer');
            const drawerTrigger = document.getElementById('drawer-trigger');
            const closeDrawerBtn = document.getElementById('close-drawer-btn');
            const materialSelect = document.getElementById('material');
            const addToProjectBtn = document.getElementById('add-to-project-btn');
            const resetBtn = document.getElementById('reset-btn');

            // === EDIT MODE INITIALIZATION ===
            if (window.editFormData) {
                isEditMode = true;
                originalRowNumber = window.editFormData.originalRowNumber;
                
                addToProjectBtn.textContent = 'Update Project';
                document.querySelector('h1').textContent = 'Edit PrintCut Estimate';
                
                setTimeout(() => populateFormData(window.editFormData), 500);
            }

            // === UTILITY FUNCTIONS ===
            function getInputValue(id) {
                const el = document.getElementById(id);
                if (el.value === '') return parseFloat(el.placeholder) || 0;
                return parseFloat(el.value) || 0;
            }

            function isChecked(id) { 
                return document.getElementById(id).checked; 
            }

            function formatCurrency(value) { 
                return isNaN(value) ? '$0.00' : value.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); 
            }
            
            function resetCosts() {
                document.getElementById('total-cost').textContent = '$0.00';
                document.getElementById('total-price').textContent = '$0.00';
                document.getElementById('unit-price').textContent = '$0.00';
            }

            function calculateEstimate() {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = '';

                const qty = getInputValue('qty');
                const artWidth = getInputValue('width');
                const artHeight = getInputValue('height');
                const isDoubleSided = isChecked('double-sided');
                const isComplex = isChecked('complex-shape');
                const isLamination = isChecked('lamination');
                const bleed = 0.25;
                const spacing = 0.25;
                const artWidthTotal = artWidth + bleed;
                const artHeightTotal = artHeight + bleed;

                if (qty <= 0 || artWidth <= 0 || artHeight <= 0) {
                    resetCosts();
                    return;
                }

                let materialCost = 0;
                let totalLinearFeet = 0;
                const selectedMaterial = materialSelect.selectedOptions[0];
                
                if (selectedMaterial && !selectedMaterial.disabled) {
                    const matType = selectedMaterial.dataset.type;
                    
                    if (matType === 'Roll') {
                        const rollWidth = parseFloat(selectedMaterial.dataset.width);
                        if (artWidthTotal > rollWidth && artHeightTotal > rollWidth) {
                            errorDiv.textContent = 'Artwork is wider than the selected roll.';
                            resetCosts();
                            return;
                        }

                        const linFtCost = parseFloat(selectedMaterial.dataset.linFtCost);
                        
                        const colsPortrait = Math.floor((rollWidth + spacing) / (artWidthTotal + spacing));
                        const colsLandscape = Math.floor((rollWidth + spacing) / (artHeightTotal + spacing));
                        
                        let numColumns = Math.max(colsPortrait, colsLandscape, 1);
                        let layoutRow = artHeightTotal;

                        if (colsLandscape > colsPortrait) {
                            layoutRow = artWidthTotal;
                        }

                        if (rollWidth > 0 && artWidthTotal > 0 && artHeightTotal > 0) {
                            const numRows = Math.ceil(qty / numColumns);
                            const totalLinearInches = (numRows * layoutRow) + ((numRows - 1) * spacing);
                            totalLinearFeet = totalLinearInches / 12;
                            materialCost = (totalLinearFeet + 2.5) * linFtCost;
                        }
                        
                    } else if (matType === 'Sheet') {
                        const sheetWidth = parseFloat(selectedMaterial.dataset.width);
                        const sheetHeight = parseFloat(selectedMaterial.dataset.height);
                        const artFitsPortrait = (artWidthTotal <= sheetWidth && artHeightTotal <= sheetHeight);
                        const artFitsLandscape = (artWidthTotal <= sheetHeight && artHeightTotal <= sheetWidth);
                        
                        if (!artFitsPortrait && !artFitsLandscape) {
                            errorDiv.textContent = 'Artwork is larger than the selected sheet.';
                            resetCosts();
                            return;
                        }

                        const sheetCost = parseFloat(selectedMaterial.dataset.sheetCost);
                        const perSheet1 = artFitsPortrait ? Math.floor((sheetWidth + spacing) / (artWidthTotal + spacing)) * Math.floor((sheetHeight + spacing) / (artHeightTotal + spacing)) : 0;
                        const perSheet2 = artFitsLandscape ? Math.floor((sheetWidth + spacing) / (artHeightTotal + spacing)) * Math.floor((sheetHeight + spacing) / (artWidthTotal + spacing)) : 0;
                        const piecesPerSheet = Math.max(perSheet1, perSheet2, 1);
                        const totalSheets = Math.ceil(qty / piecesPerSheet);
                        let calculatedMaterialCost = totalSheets * sheetCost;
                        const halfSheetCost = sheetCost * 0.5;
                        materialCost = Math.max(calculatedMaterialCost, halfSheetCost);
                    }
                }

                const singlePieceSqFt = (artWidthTotal * artHeightTotal) / 144;
                let totalArtworkSqFt = singlePieceSqFt * qty;
                if (isDoubleSided) {
                    totalArtworkSqFt *= 2;
                }
                
                const totalArtworkPerimeter = (artWidth * 2 + artHeight * 2) * qty;

                const printTimeHours = (totalArtworkSqFt / 0.83) / 60;
                let cutTimeHours = (totalArtworkPerimeter / 120) / 60;
                if (isComplex) cutTimeHours *= 1.5;
                const ripTimeHours = (totalArtworkSqFt / 20.52) / 60;
                const printComputeTimeHours = (totalArtworkSqFt / 6.2) / 60;
                
                let designTimeInHours = getInputValue('design-time');
                if (document.getElementById('design-unit').value === 'minutes') designTimeInHours /= 60;
                
                let weedingTime = getInputValue('weeding-time');
                if (document.getElementById('weeding-unit').value === 'minutes') weedingTime /= 60;
                let maskingTime = getInputValue('masking-time');
                if (document.getElementById('masking-unit').value === 'minutes') maskingTime /= 60;
                let finishingTime = getInputValue('finishing-time');
                if (document.getElementById('finishing-unit').value === 'minutes') finishingTime /= 60;
                
                const manualOperatorTimeInHours = weedingTime + maskingTime + finishingTime;
                
                const totalProjectRunTimeHours = printTimeHours + cutTimeHours + ripTimeHours + printComputeTimeHours;
                
                const inkCost = totalArtworkSqFt * 0.165;
                const cuttingCost = cutTimeHours * 25.00;
                const baseDesignCost = (totalArtworkSqFt / 25) * 0.0625 * 60.00;
                const manualDesignCost = designTimeInHours * 60.00;
                const designCost = baseDesignCost + manualDesignCost;
                
                let laminationCost = 0;
                if (isLamination) {
                    if (selectedMaterial && selectedMaterial.dataset.type === 'Roll') {
                        laminationCost = totalLinearFeet * 1.02;
                    } else {
                        // For sheets, approximate lamination cost based on total square footage
                        // Cost per sq ft = 1.02 / (54/12) = $0.2267
                        laminationCost = totalArtworkSqFt * 0.2267;
                    }
                }
                
                const equipmentCost = totalProjectRunTimeHours * 4.95;
                const operatorCost = (totalProjectRunTimeHours + manualOperatorTimeInHours) * 28.00;

                const totalCost = materialCost + inkCost + cuttingCost + designCost + equipmentCost + operatorCost + laminationCost;
                const margin = getInputValue('margin') / 100;
                let totalPrice = totalCost;
                if (margin < 1 && margin >= 0) {
                    totalPrice = totalCost / (1 - margin);
                } else if (margin < 0) {
                    totalPrice = totalCost / (1 - margin);
                } else {
                    totalPrice = totalCost;
                }
                const unitPrice = (qty > 0) ? totalPrice / qty : 0;
                
                document.getElementById('total-cost').textContent = `${totalCost.toFixed(2)}`;
                document.getElementById('total-price').textContent = `${totalPrice.toFixed(2)}`;
                document.getElementById('unit-price').textContent = `${unitPrice.toFixed(2)}`;
            }

            function collectFormData() {
                const formData = {
                    description: document.getElementById('description').value.trim(),
                    material: materialSelect.value,
                    quantity: getInputValue('qty'),
                    width: getInputValue('width'),
                    height: getInputValue('height'),
                    complexShape: isChecked('complex-shape'),
                    doubleSided: isChecked('double-sided'),
                    lamination: isChecked('lamination'),
                    margin: getInputValue('margin'),
                    additionalLabor: {
                        design: { time: getInputValue('design-time'), unit: document.getElementById('design-unit').value },
                        weeding: { time: getInputValue('weeding-time'), unit: document.getElementById('weeding-unit').value },
                        masking: { time: getInputValue('masking-time'), unit: document.getElementById('masking-unit').value },
                        finishing: { time: getInputValue('finishing-time'), unit: document.getElementById('finishing-unit').value }
                    }
                };

                if (isEditMode && originalRowNumber) {
                    formData.originalRowNumber = originalRowNumber;
                }

                return formData;
            }

            function populateFormData(formData) {
                if (!formData) return;

                if (formData.originalRowNumber) {
                    isEditMode = true;
                    originalRowNumber = formData.originalRowNumber;
                    
                    addToProjectBtn.textContent = 'Update Project';
                    document.querySelector('h1').textContent = 'Edit PrintCut Estimate';
                }

                if (formData.description) document.getElementById('description').value = formData.description;
                if (formData.material) materialSelect.value = formData.material;
                if (formData.quantity) document.getElementById('qty').value = formData.quantity;
                if (formData.width) document.getElementById('width').value = formData.width;
                if (formData.height) document.getElementById('height').value = formData.height;
                if (formData.margin !== undefined) document.getElementById('margin').value = formData.margin;

                if (formData.complexShape) document.getElementById('complex-shape').checked = true;
                if (formData.doubleSided) document.getElementById('double-sided').checked = true;
                if (formData.lamination) document.getElementById('lamination').checked = true;

                if (formData.additionalLabor) {
                    const labor = formData.additionalLabor;

                    if (labor.design && labor.design.time > 0) {
                        document.getElementById('design-time').value = labor.design.time;
                        document.getElementById('design-unit').value = labor.design.unit;
                    }
                    if (labor.weeding && labor.weeding.time > 0) {
                        document.getElementById('weeding-time').value = labor.weeding.time;
                        document.getElementById('weeding-unit').value = labor.weeding.unit;
                    }
                    if (labor.masking && labor.masking.time > 0) {
                        document.getElementById('masking-time').value = labor.masking.time;
                        document.getElementById('masking-unit').value = labor.masking.unit;
                    }
                    if (labor.finishing && labor.finishing.time > 0) {
                        document.getElementById('finishing-time').value = labor.finishing.time;
                        document.getElementById('finishing-unit').value = labor.finishing.unit;
                    }
                }

                setTimeout(calculateEstimate, 100);
            }

            function handleSubmit() {
                const description = document.getElementById('description').value.trim();
                const quantity = getInputValue('qty');
                const totalPriceText = document.getElementById('total-price').textContent;
                
                const totalPrice = parseFloat(totalPriceText.replace(/[^0-9.-]+/g, '')) || 0;
                
                if (!description) {
                    alert('Please enter a description before adding to project.');
                    return;
                }
                
                if (!quantity || quantity <= 0) {
                    alert('Please enter a valid quantity.');
                    return;
                }
                
                if (totalPrice <= 0) {
                    alert('Please configure your estimate to calculate a total price.');
                    return;
                }
                
                const completeFormData = collectFormData();
                
                const printingData = {
                    description: description,
                    quantity: parseInt(quantity),
                    totalPrice: totalPrice,
                    formData: completeFormData,
                    originalRowNumber: isEditMode ? originalRowNumber : null
                };
                
                addToProjectBtn.disabled = true;
                const originalButtonText = addToProjectBtn.textContent;
                addToProjectBtn.textContent = isEditMode ? 'Updating...' : 'Adding...';
                addToProjectBtn.classList.add('opacity-50');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        addToProjectBtn.disabled = false;
                        addToProjectBtn.textContent = originalButtonText;
                        addToProjectBtn.classList.remove('opacity-50');
                        
                        if (result.success) {
                            if (result.isUpdate) {
                                resetFormToNewMode();
                            } else {
                                resetForm();
                            }
                        } else {
                            alert(`Error: ${result.message}`);
                        }
                    })
                    .withFailureHandler(function(error) {
                        addToProjectBtn.disabled = false;
                        addToProjectBtn.textContent = originalButtonText;
                        addToProjectBtn.classList.remove('opacity-50');
                        
                        console.error('Error adding to project:', error);
                        alert('An error occurred while adding to the project. Please try again.');
                    })
                    .addPrintingToProject(printingData);
            }

            function resetFormToNewMode() {
                resetForm();
                isEditMode = false;
                originalRowNumber = null;
                addToProjectBtn.textContent = 'Add to Project';
                document.querySelector('h1').textContent = 'PrintCut Estimate';
                
                if (window.editFormData) {
                    delete window.editFormData;
                }
            }

            function resetForm() {
                const elements = [
                    'description', 'qty', 'width', 'height',
                    'design-time', 'weeding-time', 'masking-time', 'finishing-time'
                ];
                
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = '';
                    }
                });
                
                materialSelect.selectedIndex = 0;
                document.getElementById('margin').value = '50';
                
                const checkboxes = ['complex-shape', 'double-sided', 'lamination'];
                checkboxes.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) checkbox.checked = false;
                });
                
                document.getElementById('design-unit').value = 'minutes';
                document.getElementById('weeding-unit').value = 'minutes';
                document.getElementById('masking-unit').value = 'minutes';
                document.getElementById('finishing-unit').value = 'minutes';
                
                const summaryElements = ['total-cost', 'total-price', 'unit-price'];
                summaryElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '$0.00';
                });
                
                document.getElementById('error-message').textContent = '';
            }

            // === EVENT LISTENERS ===
            
            materialSelect.addEventListener('change', calculateEstimate);
            
            const inputElements = ['qty', 'width', 'height', 'margin', 'design-time', 'weeding-time', 'masking-time', 'finishing-time'];
            inputElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.addEventListener('input', calculateEstimate);
            });
            
            const checkboxElements = ['complex-shape', 'double-sided', 'lamination'];
            checkboxElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.addEventListener('change', calculateEstimate);
            });
            
            const dropdownElements = ['design-unit', 'weeding-unit', 'masking-unit', 'finishing-unit'];
            dropdownElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.addEventListener('change', calculateEstimate);
            });
            
            if (drawerTrigger && drawer) {
                drawerTrigger.addEventListener('click', function() {
                    drawer.classList.remove('translate-x-full');
                });
            }
            if (closeDrawerBtn && drawer) {
                closeDrawerBtn.addEventListener('click', function() {
                    drawer.classList.add('translate-x-full');
                });
            }
            
            if (resetBtn) resetBtn.addEventListener('click', resetForm);
            if (addToProjectBtn) addToProjectBtn.addEventListener('click', handleSubmit);

            // === INITIALIZATION ===
            
            // Load material data from Materials sheet (filtered for PRINT)
            google.script.run
                .withSuccessHandler(function(materials) {
                    console.log('Materials received:', materials); // Debug log
                    
                    // Hide loading message
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }
                    
                    if (materials && materials.length > 0) {
                        materialInventoryData = materials;
                        
                        // Clear existing options (including loading option)
                        materialSelect.innerHTML = '';
                        
                        // Add default option
                        let defaultOption = document.createElement('option');
                        defaultOption.textContent = 'Select a material...';
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        materialSelect.appendChild(defaultOption);
                        
                        // Add material options
                        materials.forEach(material => {
                            let option = document.createElement('option');
                            option.value = material[0]; // Material name
                            option.textContent = material[0]; // Material name
                            option.dataset.type = material[1]; // Type (Roll/Sheet)
                            option.dataset.width = material[2]; // Width
                            option.dataset.height = material[3]; // Height
                            option.dataset.sheetCost = material[4]; // Sheet cost
                            option.dataset.linFtCost = material[5]; // Linear foot cost
                            materialSelect.appendChild(option);
                            console.log('Added material:', material[0]); // Debug log
                        });
                        
                        // If in edit mode, populate after materials are loaded
                        if (window.editFormData) {
                            setTimeout(() => populateFormData(window.editFormData), 100);
                        }
                    } else {
                        console.log('No materials found or empty array returned');
                        // Clear loading option and add no materials message
                        materialSelect.innerHTML = '';
                        let noMaterialsOption = document.createElement('option');
                        noMaterialsOption.textContent = 'No PRINT materials found';
                        noMaterialsOption.disabled = true;
                        noMaterialsOption.selected = true;
                        materialSelect.appendChild(noMaterialsOption);
                    }
                    calculateEstimate();
                })
                .withFailureHandler(function(err) {
                    console.error("Failed to load materials:", err);
                    
                    // Hide loading message
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }
                    
                    // Add error option to dropdown
                    materialSelect.innerHTML = '';
                    let errorOption = document.createElement('option');
                    errorOption.textContent = 'Error loading materials';
                    errorOption.disabled = true;
                    errorOption.selected = true;
                    materialSelect.appendChild(errorOption);
                    
                    // Show error in error message div
                    const errorDiv = document.getElementById('error-message');
                    if (errorDiv) {
                        errorDiv.textContent = 'Failed to load materials: ' + err.message;
                        errorDiv.style.color = '#dc2626';
                    }
                })
                .getPrintingMaterials();
        });
    </script>
</body>
</html>
